<div
  *ngIf="!expenseService.user()"
  class="min-h-screen flex flex-col items-center justify-center p-6 bg-pastel-bg"
>
  <div
    class="bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-md border border-white/50 relative overflow-hidden"
  >
    <div
      class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pastel-primary to-pastel-secondary"
    ></div>

    <h1 class="text-3xl font-bold text-center mb-2 text-pastel-text">
      Gastos<span class="text-pastel-primary">Duo</span>
    </h1>
    <p class="text-center text-gray-400 text-sm mb-8">Finanzas en pareja, sin dramas.</p>

    <div class="space-y-4">
      <div>
        <label class="text-xs font-bold text-gray-500 ml-2">CORREO</label>
        <input [(ngModel)]="authData.email" type="email" placeholder="" class="input-pastel" />
      </div>
      <div>
        <label class="text-xs font-bold text-gray-500 ml-2">CONTRASE√ëA</label>
        <input
          [(ngModel)]="authData.password"
          type="password"
          placeholder=""
          class="input-pastel"
        />
      </div>

      <p *ngIf="authError()" class="text-red-500 text-sm font-semibold text-center">
        {{ authError() }}
      </p>

      <button
        (click)="handleAuth()"
        class="w-full bg-black text-white py-3 rounded-xl font-bold shadow-xl active:scale-95 transition"
      >
        Entrar
      </button>
    </div>
  </div>
</div>

<div
  *ngIf="expenseService.user()"
  class="pb-32 max-w-md mx-auto min-h-screen relative transition-colors"
  [style.background-color]="'var(--bg-primary)'"
>
  <header
    class="px-6 pt-8 pb-4 flex justify-between items-center sticky top-0 z-20 transition-colors"
    [style.background-color]="'var(--bg-primary)'"
  >
    <div class="flex items-center gap-2">
      <div
        class="w-10 h-10 bg-black text-white rounded-full flex items-center justify-center font-bold text-lg"
      >
        {{ expenseService.user().email[0].toUpperCase() }}
      </div>
      <div class="leading-tight">
        <p class="text-xs font-bold" [style.color]="'var(--text-secondary)'">HOLA</p>
        <p class="text-sm font-bold truncate w-32" [style.color]="'var(--text-primary)'">
          {{ expenseService.user().email.split('@')[0] }}
        </p>
      </div>
    </div>
    <div class="flex gap-2">
      <button
        (click)="toggleDarkMode()"
        class="p-2 rounded-full shadow-sm transition"
        [style.background-color]="'var(--bg-card)'"
        [style.color]="'var(--text-secondary)'"
      >
        <span class="text-xl">{{ isDarkMode() ? '‚òÄÔ∏è' : 'üåô' }}</span>
      </button>
      <button
        (click)="expenseService.logout()"
        class="px-3 py-2 rounded-full shadow-sm transition hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-500 text-xs font-semibold"
        [style.background-color]="'var(--bg-card)'"
        [style.color]="'var(--text-secondary)'"
      >
        üö™ Salir
      </button>
    </div>
  </header>

  <!-- Notificaciones Banner -->
  <div *ngIf="notifications().length > 0" class="px-6 space-y-2 mb-4 animate-fade-in">
    <div
      *ngFor="let notif of notifications(); trackBy: trackByNotificationId"
      class="rounded-xl p-4 flex justify-between items-center shadow-md animate-slide-in"
      [class.bg-yellow-100]="notif.type === 'warning'"
      [class.bg-red-100]="notif.type === 'danger'"
      [class.border-l-4]="true"
      [class.border-yellow-500]="notif.type === 'warning'"
      [class.border-red-500]="notif.type === 'danger'"
    >
      <div class="flex items-center gap-3 flex-1">
        <span class="text-2xl">{{ notif.type === 'danger' ? 'üö®' : '‚ö†Ô∏è' }}</span>
        <p
          class="text-sm font-semibold"
          [class.text-yellow-800]="notif.type === 'warning'"
          [class.text-red-800]="notif.type === 'danger'"
        >
          {{ notif.message }}
        </p>
      </div>
      <button
        (click)="dismissNotification(notif.id)"
        class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-white/50 transition"
      >
        ‚úï
      </button>
    </div>
  </div>

  <div
    *ngIf="currentTab() === 'dashboard'"
    class="p-4 sm:p-6 animate-fade-in space-y-4 sm:space-y-6"
  >
    <div
      class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-2"
    >
      <h2 class="font-bold text-xl sm:text-2xl" [style.color]="'var(--text-primary)'">Dashboard</h2>

      <div class="w-full sm:w-auto flex items-center gap-2">
        <span class="text-xs sm:text-sm font-semibold" [style.color]="'var(--text-secondary)'"
          >Mes:</span
        >
        <input
          type="month"
          [(ngModel)]="selectedMonth"
          class="input-pastel text-xs sm:text-sm px-3 py-2"
        />
      </div>
    </div>
    <button
      (click)="downloadPDFReport()"
      class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-2xl font-bold shadow-xl hover:shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-2 text-sm sm:text-base"
    >
      <span class="text-lg sm:text-xl">ÔøΩ</span>
      Descargar Estado de Cuenta PDF
    </button>

    <div
      class="relative overflow-hidden p-6 sm:p-8 rounded-[2rem] shadow-2xl border transition-all"
      [style.background-color]="'var(--bg-card)'"
      [style.border-color]="'var(--border-color)'"
    >
      <div
        *ngIf="totalJoint() > 0"
        class="absolute -right-10 -top-10 w-32 h-32 sm:w-40 sm:h-40 bg-pastel-secondary/30 rounded-full blur-2xl"
      ></div>
      <div
        *ngIf="totalJoint() > 0"
        class="absolute -left-10 -bottom-10 w-32 h-32 sm:w-40 sm:h-40 bg-pastel-primary/30 rounded-full blur-2xl"
      ></div>

      <p
        class="text-xs sm:text-sm font-medium relative z-10 uppercase tracking-widest"
        [style.color]="'var(--text-secondary)'"
      >
        Total Mes
      </p>

      <div *ngIf="totalJoint() > 0; else emptyState">
        <h2
          class="text-4xl sm:text-5xl font-bold mt-2 relative z-10 tracking-tight"
          [style.color]="'var(--text-primary)'"
        >
          ${{ totalJoint() | number : '1.0-0' }}
        </h2>

        <div class="mt-4 sm:mt-6 relative z-10">
          <div class="flex gap-1 sm:gap-2 mb-2">
            <div
              class="h-3 sm:h-4 rounded-full bg-pastel-secondary transition-all"
              [style.width.%]="myTotal() > 0 ? (myTotal() / totalJoint()) * 100 : 0"
            ></div>
            <div
              class="h-3 sm:h-4 rounded-full bg-pastel-primary transition-all"
              [style.width.%]="partnerTotal() > 0 ? (partnerTotal() / totalJoint()) * 100 : 0"
            ></div>
          </div>
          <div
            class="flex justify-between text-xs sm:text-sm font-bold"
            [style.color]="'var(--text-secondary)'"
          >
            <span
              >{{ expenseService.user().email.split('@')[0].toUpperCase() }}: ${{ myTotal() }}</span
            >
            <span>PAREJA: ${{ partnerTotal() }}</span>
          </div>
        </div>
      </div>

      <ng-template #emptyState>
        <div class="py-8 text-center opacity-50">
          <span class="text-4xl block mb-2">üò¥</span>
          <p [style.color]="'var(--text-secondary)'">Sin movimientos este mes</p>
        </div>
      </ng-template>
    </div>

    <div *ngIf="totalJoint() > 0" class="animate-fade-in">
      <h3 class="font-bold px-2 mb-3 text-base sm:text-lg" [style.color]="'var(--text-primary)'">
        Desglose Mensual
      </h3>
      <div class="space-y-2 sm:space-y-3">
        <div
          *ngFor="let cat of categoryStats()"
          class="p-3 sm:p-4 rounded-2xl flex items-center gap-3 sm:gap-4 shadow-sm border transition"
          [style.background-color]="'var(--bg-card)'"
          [style.border-color]="'var(--border-color)'"
        >
          <div class="text-xl sm:text-2xl w-8 sm:w-10 text-center">{{ cat.icon }}</div>
          <div class="flex-1">
            <div class="flex justify-between mb-1">
              <span class="font-bold text-xs sm:text-sm" [style.color]="'var(--text-primary)'">{{
                cat.name
              }}</span>
              <span class="font-bold text-xs sm:text-sm" [style.color]="'var(--text-primary)'">
                >${{ cat.total }}</span
              >
            </div>
            <div class="w-full bg-gray-50 rounded-full h-2 overflow-hidden">
              <div
                class="h-full bg-pastel-accent transition-all duration-1000"
                [style.width.%]="cat.percent"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nuevas Secciones de An√°lisis -->
    <div *ngIf="totalJoint() > 0" class="space-y-4 sm:space-y-6 animate-fade-in">
      <!-- Tendencias Mensuales -->
      <div
        class="p-4 sm:p-6 rounded-2xl shadow-lg border transition"
        [style.background-color]="'var(--bg-card)'"
        [style.border-color]="'var(--border-color)'"
      >
        <h3 class="font-bold text-base sm:text-lg mb-3" [style.color]="'var(--text-primary)'">
          üìà Tendencias Mensuales
        </h3>
        <div class="flex justify-between items-end gap-2">
          <div *ngFor="let trend of monthlyTrends().trends" class="flex-1 text-center">
            <div
              class="bg-gradient-to-t from-pastel-primary to-pastel-secondary rounded-t-lg mb-2 transition-all hover:opacity-80"
              [style.height.px]="
                trend.total > 0 ? Math.max(40, (trend.total / monthlyTrends().maxTotal) * 120) : 10
              "
            ></div>
            <p class="text-xs font-bold" [style.color]="'var(--text-secondary)'">
              {{ trend.month }}
            </p>
            <p class="text-sm font-bold" [style.color]="'var(--text-primary)'">
              {{ trend.total > 0 ? '$' + (trend.total | number : '1.0-0') : '-' }}
            </p>
          </div>
        </div>
      </div>

      <!-- Comparativa Individual -->
      <div
        *ngIf="individualComparison()"
        class="p-4 sm:p-6 rounded-2xl shadow-lg border transition"
        [style.background-color]="'var(--bg-card)'"
        [style.border-color]="'var(--border-color)'"
      >
        <h3 class="font-bold text-base sm:text-lg mb-4" [style.color]="'var(--text-primary)'">
          üë• Distribuci√≥n Individual
        </h3>
        <div class="space-y-3">
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-bold" [style.color]="'var(--text-secondary)'">{{
                expenseService.user().email.split('@')[0]
              }}</span>
              <span class="text-sm font-bold" [style.color]="'var(--text-primary)'"
                >{{ individualComparison()!.myPercent }}%</span
              >
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
              <div
                class="h-full bg-pastel-secondary transition-all duration-1000"
                [style.width.%]="individualComparison()!.myPercent"
              ></div>
            </div>
            <p class="text-xs text-gray-400 mt-1">
              ${{ individualComparison()!.myTotal | number : '1.0-0' }}
            </p>
          </div>
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-bold" [style.color]="'var(--text-secondary)'">Pareja</span>
              <span class="text-sm font-bold" [style.color]="'var(--text-primary)'"
                >{{ individualComparison()!.partnerPercent }}%</span
              >
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
              <div
                class="h-full bg-pastel-primary transition-all duration-1000"
                [style.width.%]="individualComparison()!.partnerPercent"
              ></div>
            </div>
            <p class="text-xs text-gray-400 mt-1">
              ${{ individualComparison()!.partnerTotal | number : '1.0-0' }}
            </p>
          </div>
        </div>
      </div>

      <!-- H√°bitos de Gasto -->
      <div
        *ngIf="spendingHabits()"
        class="p-4 sm:p-6 rounded-2xl shadow-lg border transition"
        [style.background-color]="'var(--bg-card)'"
        [style.border-color]="'var(--border-color)'"
      >
        <h3 class="font-bold text-base sm:text-lg mb-4" [style.color]="'var(--text-primary)'">
          üí° H√°bitos de Gasto
        </h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="text-center p-3 rounded-xl" [style.background-color]="'var(--bg-input)'">
            <p class="text-xs font-semibold mb-1" [style.color]="'var(--text-secondary)'">
              Promedio Diario
            </p>
            <p class="text-xl font-bold" [style.color]="'var(--text-primary)'">
              ${{ spendingHabits()!.dailyAverage }}
            </p>
          </div>
          <div class="text-center p-3 rounded-xl" [style.background-color]="'var(--bg-input)'">
            <p class="text-xs font-semibold mb-1" [style.color]="'var(--text-secondary)'">
              D√≠a M√°s Activo
            </p>
            <p class="text-xl font-bold" [style.color]="'var(--text-primary)'">
              {{ spendingHabits()!.mostActiveDay }}
            </p>
          </div>
          <div
            class="text-center p-3 rounded-xl col-span-2"
            [style.background-color]="'var(--bg-input)'"
          >
            <p class="text-xs font-semibold mb-1" [style.color]="'var(--text-secondary)'">
              Categor√≠a Frecuente
            </p>
            <p class="text-lg font-bold" [style.color]="'var(--text-primary)'">
              {{ getIcon(spendingHabits()!.mostFrequentCategory!) }}
              {{ spendingHabits()!.mostFrequentCategory }}
            </p>
          </div>
        </div>
      </div>

      <!-- Potencial de Ahorro -->
      <div
        *ngIf="savingsPotential().length > 0"
        class="p-4 sm:p-6 rounded-2xl shadow-lg border-2 border-yellow-400 transition"
        [style.background-color]="'var(--bg-card)'"
      >
        <h3 class="font-bold text-base sm:text-lg mb-3" [style.color]="'var(--text-primary)'">
          üí∞ Oportunidades de Ahorro
        </h3>
        <div class="space-y-2">
          <div
            *ngFor="let suggestion of savingsPotential()"
            class="flex justify-between items-center p-3 rounded-xl bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800"
          >
            <div class="flex items-center gap-2">
              <span class="text-lg">{{ getIcon(suggestion.category) }}</span>
              <p class="text-sm font-semibold" [style.color]="'var(--text-primary)'">
                {{ suggestion.message }}
              </p>
            </div>
            <p class="text-sm font-bold text-yellow-700 dark:text-yellow-300">
              ~${{ suggestion.amount }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="currentTab() === 'movements'" class="p-6 animate-fade-in space-y-6">
    <div
      class="p-6 rounded-[2rem] shadow-lg border relative transition-all"
      [style.background-color]="'var(--bg-card)'"
      [style.border-color]="'var(--border-color)'"
      [class.ring-2]="isEditing()"
      [class.ring-pastel-primary]="isEditing()"
    >
      <div class="flex justify-between items-center mb-6">
        <h3 class="font-bold text-xl" [style.color]="'var(--text-primary)'">
          {{
            isEditing()
              ? 'Editar Gasto ‚úèÔ∏è'
              : 'Nuevo
          Gasto ‚ú®'
          }}
        </h3>
        <button
          *ngIf="isEditing()"
          (click)="cancelEdit()"
          class="text-xs bg-gray-100 px-3 py-1 rounded-full text-gray-500"
        >
          Cancelar
        </button>
      </div>

      <div class="space-y-4">
        <input [(ngModel)]="expenseForm.name" placeholder="Concepto" class="input-pastel text-lg" />

        <div class="flex gap-3">
          <div class="flex items-center gap-2">
            <span class="text-2xl font-bold" [style.color]="'var(--text-secondary)'">$</span>
            <input
              [(ngModel)]="expenseForm.amount"
              type="number"
              min="0"
              max="1000000"
              step="5"
              placeholder="0"
              class="input-pastel font-bold text-l flex-1"
            />
          </div>
          <input
            [(ngModel)]="expenseForm.date"
            type="date"
            class="input-pastel text-gray-500 text-sm"
          />
        </div>

        <div class="grid grid-cols-4 gap-2">
          <button
            *ngFor="let cat of categories"
            (click)="expenseForm.category = cat"
            class="p-2 rounded-xl text-xl flex flex-col items-center justify-center transition border-2"
            [class.border-black]="expenseForm.category === cat"
            [class.bg-gray-50]="expenseForm.category !== cat"
            [class.border-transparent]="expenseForm.category !== cat"
          >
            {{ getIcon(cat) }}
          </button>
        </div>

        <!-- Checkbox para vincular a concepto a plazos -->
        <div
          *ngIf="!isEditing()"
          class="flex items-center gap-3 p-3 rounded-xl border transition"
          [style.border-color]="'var(--border-color)'"
        >
          <input
            type="checkbox"
            [(ngModel)]="linkToInstallment"
            id="linkInstallment"
            class="w-5 h-5 rounded accent-black cursor-pointer"
          />
          <label
            for="linkInstallment"
            class="text-sm font-semibold cursor-pointer flex-1"
            [style.color]="'var(--text-primary)'"
          >
            üìÖ Es aportaci√≥n a un gasto a plazos
          </label>
        </div>

        <!-- Selector de concepto a plazos -->
        <div *ngIf="linkToInstallment() && !isEditing()" class="space-y-2">
          <select [(ngModel)]="selectedInstallmentId" class="input-pastel">
            <option [ngValue]="null">Selecciona el concepto</option>
            <option
              *ngFor="let concept of activeInstallmentConcepts()"
              [ngValue]="concept.conceptId"
            >
              {{ concept.conceptName }} - Restante: ${{ concept.remaining }}
            </option>
          </select>

          <!-- Mostrar informaci√≥n del concepto seleccionado -->
          <div
            *ngIf="selectedInstallmentId()"
            class="p-3 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800"
          >
            <p class="text-xs font-semibold text-blue-800 dark:text-blue-200">
              üí° Monto restante: ${{
                getInstallmentStats(selectedInstallmentId()!)?.remaining || 0
              }}
              - No puedes aportar m√°s que esto.
            </p>
          </div>
        </div>

        <button
          (click)="saveExpense()"
          class="w-full py-4 rounded-xl font-bold shadow-xl active:scale-95 transition mt-2 text-white"
          [class.bg-pastel-tertiary]="isEditing()"
          [class.bg-black]="!isEditing()"
        >
          {{ isEditing() ? 'Guardar Cambios' : 'Agregar Gasto' }}
        </button>
      </div>
    </div>

    <!-- TOGGLE: Bot√≥n para mostrar formulario de concepto a plazos -->
    <button
      (click)="toggleInstallmentForm()"
      class="w-full py-3 rounded-xl font-bold shadow-md active:scale-95 transition border-2"
      [class.border-pastel-primary]="showInstallmentForm()"
      [class.bg-pastel-primary]="showInstallmentForm()"
      [class.text-white]="showInstallmentForm()"
      [class.border-gray-200]="!showInstallmentForm()"
      [style.background-color]="!showInstallmentForm() ? 'var(--bg-card)' : ''"
      [style.color]="!showInstallmentForm() ? 'var(--text-primary)' : ''"
    >
      {{ showInstallmentForm() ? '‚úï Cerrar' : '‚ûï Crear Concepto a Plazos' }}
    </button>

    <!-- FORMULARIO: Crear concepto a plazos (colapsable) -->
    <div
      *ngIf="showInstallmentForm()"
      class="p-6 rounded-[2rem] shadow-lg border animate-fade-in"
      [style.background-color]="'var(--bg-card)'"
      [style.border-color]="'var(--border-color)'"
    >
      <h3 class="font-bold text-xl mb-4" [style.color]="'var(--text-primary)'">
        Nuevo Concepto a Plazos üìÖ
      </h3>
      <p class="text-sm mb-4" [style.color]="'var(--text-secondary)'">
        Crea un concepto para un gasto grande que pagar√°s en varias aportaciones
      </p>

      <div class="space-y-4">
        <input
          [(ngModel)]="installmentConceptForm.name"
          placeholder="Ej: Compra de Laptop"
          class="input-pastel text-lg"
        />

        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold" [style.color]="'var(--text-secondary)'">$</span>
          <input
            [(ngModel)]="installmentConceptForm.totalAmount"
            type="number"
            min="0"
            step="100"
            placeholder="Monto total"
            class="input-pastel font-bold text-xl flex-1"
          />
        </div>

        <div class="grid grid-cols-4 gap-2">
          <button
            *ngFor="let cat of categories"
            (click)="installmentConceptForm.category = cat"
            class="p-2 rounded-xl text-xl flex flex-col items-center justify-center transition border-2"
            [class.border-black]="installmentConceptForm.category === cat"
            [class.border-transparent]="installmentConceptForm.category !== cat"
            [style.background-color]="
              installmentConceptForm.category === cat ? 'var(--bg-input)' : 'transparent'
            "
          >
            {{ getIcon(cat) }}
          </button>
        </div>

        <button
          (click)="createInstallmentConcept()"
          class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-xl active:scale-95 transition"
        >
          Crear Concepto
        </button>
      </div>
    </div>

    <!-- SECCI√ìN: Conceptos a plazos activos -->
    <div *ngIf="installmentConcepts().length > 0" class="space-y-3 installment-concepts-section">
      <h3 class="font-bold px-2" [style.color]="'var(--text-primary)'">
        Conceptos a Plazos Activos
      </h3>

      <div
        *ngFor="let concept of installmentConcepts()"
        class="p-4 rounded-2xl shadow-sm border transition-all"
        [style.background-color]="'var(--bg-card)'"
        [style.border-color]="'var(--border-color)'"
        [class.installment-completed]="concept.remaining === 0"
      >
        <!-- Encabezado del concepto -->
        <div class="flex justify-between items-start mb-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-2xl">{{ getIcon(concept.category) }}</span>
              <h4 class="font-bold text-base" [style.color]="'var(--text-primary)'">
                {{ concept.conceptName }}
              </h4>
              <!-- Badge de completado -->
              <span
                *ngIf="concept.remaining === 0"
                class="completed-badge text-xs bg-green-600 text-white px-3 py-1 rounded-full font-bold flex items-center gap-1"
              >
                ‚úÖ Completado
              </span>
            </div>
            <p class="text-xs text-gray-400 mt-1">
              Total: ${{ concept.totalAmount }} ¬∑ Aportado: ${{ concept.contributed }}
            </p>
          </div>
          <div class="text-right">
            <p
              class="text-2xl font-bold"
              [style.color]="concept.remaining === 0 ? '#10b981' : 'var(--text-primary)'"
            >
              <span *ngIf="concept.remaining === 0">üéâ</span>
              ${{ concept.remaining }}
            </p>
            <p
              class="text-xs"
              [class.text-green-600]="concept.remaining === 0"
              [class.text-gray-400]="concept.remaining > 0"
            >
              {{ concept.remaining === 0 ? '¬°Pagado!' : 'restante' }}
            </p>
          </div>
        </div>

        <!-- Barra de progreso -->
        <div class="mb-3">
          <div class="flex justify-between text-xs font-bold mb-1">
            <span [style.color]="'var(--text-secondary)'">Progreso</span>
            <span [style.color]="'var(--text-secondary)'"
              >{{ concept.percentage | number : '1.0-0' }}%</span
            >
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
            <div
              class="h-full transition-all duration-1000"
              [style.width.%]="concept.percentage > 100 ? 100 : concept.percentage"
              [class.bg-green-500]="concept.percentage < 70 || concept.percentage === 100"
              [class.bg-yellow-500]="
                concept.percentage >= 70 && concept.percentage < 90 && concept.percentage < 100
              "
              [class.bg-pastel-primary]="concept.percentage >= 90 && concept.percentage < 100"
            ></div>
          </div>
        </div>

        <!-- Lista de contribuciones -->
        <details class="text-sm">
          <summary class="cursor-pointer font-semibold" [style.color]="'var(--text-secondary)'">
            Ver aportaciones ({{ concept.contributions.length }})
          </summary>
          <div class="mt-2 space-y-2">
            <div
              *ngFor="let contrib of concept.contributions"
              class="flex justify-between items-center p-2 rounded-lg"
              [style.background-color]="'var(--bg-input)'"
            >
              <div>
                <p class="text-xs font-semibold" [style.color]="'var(--text-primary)'">
                  {{ contrib.name }}
                </p>
                <p class="text-xs text-gray-400">
                  {{ contrib.date }} ¬∑
                  {{ contrib.user_id === expenseService.user()?.id ? 'T√∫' : 'Pareja' }}
                </p>
              </div>
              <p class="font-bold text-green-600">${{ contrib.amount }}</p>
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- Notificaci√≥n de celebraci√≥n -->
    <div *ngIf="showCelebration()" class="celebration-notification">
      <span class="icon">üéâ</span>
      ¬°Concepto Completado!
    </div>

    <div class="flex justify-between items-end px-2">
      <h3 class="font-bold" [style.color]="'var(--text-primary)'">√öltimos movimientos</h3>
      <span class="text-xs bg-pastel-bg px-2 py-1 rounded text-gray-500"
        >{{ expenseService.expenses().length }} reg.</span
      >
    </div>

    <div
      *ngFor="let item of expenseService.expenses()"
      class="group p-4 rounded-2xl flex justify-between items-center shadow-sm hover:shadow-md transition cursor-pointer border-l-4"
      [style.background-color]="'var(--bg-card)'"
      [class.border-pastel-secondary]="item.user_id === expenseService.user().id"
      [class.border-pastel-primary]="item.user_id !== expenseService.user().id"
      (click)="
        item.user_id === expenseService.user().id && !item.is_installment_concept
          ? edit(item)
          : null
      "
    >
      <div class="flex items-center gap-4">
        <div class="text-2xl">{{ getIcon(item.category) }}</div>
        <div>
          <div class="flex items-center gap-2">
            <p class="font-bold" [style.color]="'var(--text-primary)'">{{ item.name }}</p>
            <!-- Badge si es aportaci√≥n a concepto -->
            <span
              *ngIf="item.installment_concept_id"
              class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded-full font-semibold"
            >
              üìÖ
            </span>
            <!-- Badge si es concepto -->
            <span
              *ngIf="item.is_installment_concept"
              class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-0.5 rounded-full font-semibold"
            >
              üìã Concepto
            </span>
          </div>
          <div class="flex gap-2 text-xs text-gray-400 font-semibold">
            <span>{{ item.date }}</span>
            <span
              *ngIf="item.user_id === expenseService.user().id"
              class="text-pastel-secondary bg-green-50 px-1 rounded"
              >T√∫</span
            >
          </div>
        </div>
      </div>

      <div class="flex flex-col items-end">
        <p class="font-bold text-lg" [style.color]="'var(--text-primary)'">${{ item.amount }}</p>
        <button
          *ngIf="item.user_id === expenseService.user().id && !item.is_installment_concept"
          (click)="$event.stopPropagation(); delete(item.id!)"
          class="opacity-0 group-hover:opacity-100 transition text-xs text-red-400 hover:bg-red-50 px-2 py-1 rounded mt-1"
        >
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="currentTab() === 'budgets'" class="p-6 animate-fade-in space-y-6">
    <div
      class="p-6 rounded-[2rem] shadow-lg border relative transition-all"
      [style.background-color]="'var(--bg-card)'"
      [style.border-color]="'var(--border-color)'"
    >
      <div class="mb-6">
        <h3 class="font-bold text-xl mb-2" [style.color]="'var(--text-primary)'">
          Definir Presupuesto üí∞
        </h3>
        <p class="text-sm" [style.color]="'var(--text-secondary)'">
          Establece l√≠mites para controlar tus gastos
        </p>
      </div>

      <div class="space-y-4">
        <div class="grid grid-cols-4 gap-2">
          <button
            *ngFor="let cat of categories"
            (click)="budgetForm.category = cat"
            class="p-3 rounded-xl text-xl flex flex-col items-center justify-center transition border-2"
            [class.border-black]="budgetForm.category === cat"
            [class.border-transparent]="budgetForm.category !== cat"
            [style.background-color]="
              budgetForm.category === cat ? 'var(--bg-input)' : 'transparent'
            "
          >
            {{ getIcon(cat) }}
            <span class="text-xs mt-1" [style.color]="'var(--text-secondary)'">{{ cat }}</span>
          </button>
        </div>

        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold" [style.color]="'var(--text-secondary)'">$</span>
          <input
            [(ngModel)]="budgetForm.limit"
            type="number"
            placeholder="L√≠mite mensual"
            class="input-pastel font-bold text-xl flex-1"
          />
        </div>

        <button
          (click)="saveBudget()"
          class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-xl active:scale-95 transition"
        >
          Guardar Presupuesto
        </button>
      </div>
    </div>

    <div *ngIf="categoryProgress().length > 0">
      <h3 class="font-bold px-2 mb-3" [style.color]="'var(--text-primary)'">Progreso del Mes</h3>

      <div class="space-y-3">
        <div
          *ngFor="let item of categoryProgress()"
          class="p-4 rounded-2xl shadow-sm border transition relative overflow-hidden"
          [style.background-color]="'var(--bg-card)'"
          [style.border-color]="'var(--border-color)'"
        >
          <div class="flex justify-between items-center mb-2 relative z-10">
            <div class="flex items-center gap-2">
              <span class="text-2xl">{{ getIcon(item.category) }}</span>
              <span class="font-bold" [style.color]="'var(--text-primary)'">{{
                item.category
              }}</span>
            </div>
            <button
              (click)="deleteBudget(item.category)"
              class="text-xs text-red-400 hover:bg-red-50 px-2 py-1 rounded transition"
            >
              Eliminar
            </button>
          </div>

          <div class="mb-2 relative z-10">
            <div class="flex justify-between text-sm font-semibold mb-1">
              <span [style.color]="'var(--text-secondary)'">Gastado: ${{ item.spent }}</span>
              <span [style.color]="'var(--text-secondary)'">L√≠mite: ${{ item.limit }}</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
              <div
                class="h-full transition-all duration-1000"
                [style.width.%]="item.percent > 100 ? 100 : item.percent"
                [class.bg-green-500]="item.status === 'ok'"
                [class.bg-yellow-500]="item.status === 'warning'"
                [class.bg-red-500]="item.status === 'danger'"
              ></div>
            </div>
            <p
              class="text-xs text-center mt-1 font-bold"
              [class.text-green-600]="item.status === 'ok'"
              [class.text-yellow-600]="item.status === 'warning'"
              [class.text-red-600]="item.status === 'danger'"
            >
              {{ item.percent | number : '1.0-0' }}% utilizado
            </p>
          </div>

          <div
            *ngIf="item.percent > 100"
            class="absolute inset-0 bg-red-500/5 animate-pulse pointer-events-none"
          ></div>
        </div>
      </div>
    </div>

    <div *ngIf="categoryProgress().length === 0" class="text-center py-12 opacity-50">
      <span class="text-5xl block mb-3">üí∞</span>
      <p [style.color]="'var(--text-secondary)'">A√∫n no has definido presupuestos</p>
      <p class="text-sm mt-1" [style.color]="'var(--text-secondary)'">
        Crea uno arriba para empezar a controlar tus gastos
      </p>
    </div>
  </div>

  <div
    *ngIf="currentTab() === 'balance'"
    class="p-6 animate-fade-in flex flex-col justify-center h-[80vh]"
  >
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold" [style.color]="'var(--text-primary)'">Balance de Cuentas</h2>
      <p class="text-sm" [style.color]="'var(--text-secondary)'">¬øQui√©n paga la pr√≥xima cena?</p>
    </div>

    <div
      class="p-10 rounded-[3rem] shadow-2xl text-center border-4 relative"
      [style.background-color]="'var(--bg-card)'"
      [class.border-pastel-secondary]="balance() > 0"
      [class.border-pastel-primary]="balance() < 0"
      [class.border-gray-100]="balance() === 0"
    >
      <div class="text-6xl mb-4 animate-bounce">
        {{ balance() > 0 ? 'ü§ë' : balance() < 0 ? 'üí∏' : 'ü§ù' }}
      </div>

      <h3 class="text-gray-500 font-bold uppercase tracking-widest text-xs mb-2">
        {{ balance() > 0 ? 'TE DEBEN' : balance() < 0 ? 'DEBES' : 'A MANO' }}
      </h3>

      <h1 class="text-6xl font-black mb-6" [style.color]="'var(--text-primary)'">
        ${{ (balance() < 0 ? balance() * -1 : balance()) | number : '1.0-0' }}
      </h1>

      <p class="text-sm text-gray-400 px-4 leading-relaxed">
        <span *ngIf="balance() > 0"
          >Yeini ha gastado menos. Deber√≠a invitar la pr√≥xima salida para compensar.</span
        >
        <span *ngIf="balance() < 0"
          >Airam ha gastado menos que Yeini. Le toca poner para equilibrar la balanza.</span
        >
        <span *ngIf="balance() === 0">¬°Incre√≠ble! Han gastado exactamente lo mismo.</span>
      </p>
    </div>
  </div>

  <nav
    class="fixed bottom-8 left-8 right-8 backdrop-blur-xl border rounded-full p-2 flex justify-between shadow-2xl z-50 max-w-xs mx-auto transition-colors"
    [style.background-color]="'var(--bg-card)'"
    [style.border-color]="'var(--border-color)'"
  >
    <button
      (click)="currentTab.set('dashboard')"
      class="nav-btn"
      [class.active]="currentTab() === 'dashboard'"
    >
      üìä
    </button>
    <button
      (click)="currentTab.set('movements')"
      class="nav-btn"
      [class.active]="currentTab() === 'movements'"
    >
      üí∏
    </button>
    <button
      (click)="currentTab.set('budgets')"
      class="nav-btn"
      [class.active]="currentTab() === 'budgets'"
    >
      üí∞
    </button>
    <button
      (click)="currentTab.set('balance')"
      class="nav-btn"
      [class.active]="currentTab() === 'balance'"
    >
      ‚öñÔ∏è
    </button>
  </nav>
</div>
