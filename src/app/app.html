<div
  *ngIf="!expenseService.user()"
  class="min-h-screen flex flex-col items-center justify-center p-6 bg-pastel-bg"
>
  <div
    class="bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-md border border-white/50 relative overflow-hidden"
  >
    <div
      class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pastel-primary to-pastel-secondary"
    ></div>

    <h1 class="text-3xl font-bold text-center mb-2 text-pastel-text">
      Gastos<span class="text-pastel-primary">Duo</span>
    </h1>
    <p class="text-center text-gray-400 text-sm mb-8">Finanzas en pareja, sin dramas.</p>

    <div class="space-y-4">
      <div>
        <label class="text-xs font-bold text-gray-500 ml-2">CORREO</label>
        <input [(ngModel)]="authData.email" type="email" placeholder="" class="input-pastel" />
      </div>
      <div>
        <label class="text-xs font-bold text-gray-500 ml-2">CONTRASEÃ‘A</label>
        <input
          [(ngModel)]="authData.password"
          type="password"
          placeholder=""
          class="input-pastel"
        />
      </div>

      <p *ngIf="authError()" class="text-red-500 text-sm font-semibold text-center">
        {{ authError() }}
      </p>

      <button
        (click)="handleAuth()"
        class="w-full bg-black text-white py-3 rounded-xl font-bold shadow-xl active:scale-95 transition"
      >
        Entrar
      </button>
    </div>
  </div>
</div>

<div
  *ngIf="expenseService.user()"
  class="pb-32 max-w-md mx-auto min-h-screen relative transition-colors"
  [style.background-color]="'var(--bg-primary)'"
>
  <header
    class="px-6 pt-8 pb-4 flex justify-between items-center sticky top-0 z-20 transition-colors"
    [style.background-color]="'var(--bg-primary)'"
  >
    <div class="flex items-center gap-2">
      <div
        class="w-10 h-10 bg-black text-white rounded-full flex items-center justify-center font-bold text-lg"
      >
        {{ expenseService.user().email[0].toUpperCase() }}
      </div>
      <div class="leading-tight">
        <p class="text-xs font-bold" [style.color]="'var(--text-secondary)'">HOLA</p>
        <p class="text-sm font-bold truncate w-32" [style.color]="'var(--text-primary)'">
          {{ expenseService.user().email.split('@')[0] }}
        </p>
      </div>
    </div>
    <div class="flex gap-2">
      <button
        (click)="toggleDarkMode()"
        class="p-2 rounded-full shadow-sm transition"
        [style.background-color]="'var(--bg-card)'"
        [style.color]="'var(--text-secondary)'"
      >
        <span class="text-xl">{{ isDarkMode() ? 'â˜€ï¸' : 'ğŸŒ™' }}</span>
      </button>
      <button
        (click)="expenseService.logout()"
        class="px-3 py-2 rounded-full shadow-sm transition hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-500 text-xs font-semibold"
        [style.background-color]="'var(--bg-card)'"
        [style.color]="'var(--text-secondary)'"
      >
        ğŸšª Salir
      </button>
    </div>
  </header>

  <!-- Notificaciones Banner -->
  <div *ngIf="notifications().length > 0" class="px-6 space-y-2 mb-4 animate-fade-in">
    <div
      *ngFor="let notif of notifications(); trackBy: trackByNotificationId"
      class="rounded-xl p-4 flex justify-between items-center shadow-md animate-slide-in"
      [class.bg-yellow-100]="notif.type === 'warning'"
      [class.bg-red-100]="notif.type === 'danger'"
      [class.border-l-4]="true"
      [class.border-yellow-500]="notif.type === 'warning'"
      [class.border-red-500]="notif.type === 'danger'"
    >
      <div class="flex items-center gap-3 flex-1">
        <span class="text-2xl">{{ notif.type === 'danger' ? 'ğŸš¨' : 'âš ï¸' }}</span>
        <p
          class="text-sm font-semibold"
          [class.text-yellow-800]="notif.type === 'warning'"
          [class.text-red-800]="notif.type === 'danger'"
        >
          {{ notif.message }}
        </p>
      </div>
      <button
        (click)="dismissNotification(notif.id)"
        class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-white/50 transition"
      >
        âœ•
      </button>
    </div>
  </div>

  <div
    *ngIf="currentTab() === 'dashboard'"
    class="p-4 sm:p-6 animate-fade-in space-y-4 sm:space-y-6"
  >
    <div
      class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-2"
    >
      <h2 class="font-bold text-xl sm:text-2xl" [style.color]="'var(--text-primary)'">Dashboard</h2>

      <div class="w-full sm:w-auto flex items-center gap-2">
        <span class="text-xs sm:text-sm font-semibold" [style.color]="'var(--text-secondary)'"
          >Mes:</span
        >
        <input
          type="month"
          [(ngModel)]="selectedMonth"
          class="input-pastel text-xs sm:text-sm px-3 py-2"
        />
      </div>
    </div>
    <button
      (click)="downloadReport()"
      class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-2xl font-bold shadow-xl hover:shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-2 text-sm sm:text-base"
    >
      <span class="text-lg sm:text-xl">ğŸ“Š</span>
      Descargar Excel
    </button>

    <div
      class="relative overflow-hidden p-6 sm:p-8 rounded-[2rem] shadow-2xl border transition-all"
      [style.background-color]="'var(--bg-card)'"
      [style.border-color]="'var(--border-color)'"
    >
      <div
        *ngIf="totalJoint() > 0"
        class="absolute -right-10 -top-10 w-32 h-32 sm:w-40 sm:h-40 bg-pastel-secondary/30 rounded-full blur-2xl"
      ></div>
      <div
        *ngIf="totalJoint() > 0"
        class="absolute -left-10 -bottom-10 w-32 h-32 sm:w-40 sm:h-40 bg-pastel-primary/30 rounded-full blur-2xl"
      ></div>

      <p
        class="text-xs sm:text-sm font-medium relative z-10 uppercase tracking-widest"
        [style.color]="'var(--text-secondary)'"
      >
        Total Mes
      </p>

      <div *ngIf="totalJoint() > 0; else emptyState">
        <h2
          class="text-4xl sm:text-5xl font-bold mt-2 relative z-10 tracking-tight"
          [style.color]="'var(--text-primary)'"
        >
          ${{ totalJoint() | number : '1.0-0' }}
        </h2>

        <div class="mt-4 sm:mt-6 relative z-10">
          <div class="flex gap-1 sm:gap-2 mb-2">
            <div
              class="h-3 sm:h-4 rounded-full bg-pastel-secondary transition-all"
              [style.width.%]="myTotal() > 0 ? (myTotal() / totalJoint()) * 100 : 0"
            ></div>
            <div
              class="h-3 sm:h-4 rounded-full bg-pastel-primary transition-all"
              [style.width.%]="partnerTotal() > 0 ? (partnerTotal() / totalJoint()) * 100 : 0"
            ></div>
          </div>
          <div
            class="flex justify-between text-xs sm:text-sm font-bold"
            [style.color]="'var(--text-secondary)'"
          >
            <span>AIRAM: ${{ myTotal() }}</span>
            <span>YEINI: ${{ partnerTotal() }}</span>
          </div>
        </div>
      </div>

      <ng-template #emptyState>
        <div class="py-8 text-center opacity-50">
          <span class="text-4xl block mb-2">ğŸ˜´</span>
          <p [style.color]="'var(--text-secondary)'">Sin movimientos este mes</p>
        </div>
      </ng-template>
    </div>

    <div *ngIf="totalJoint() > 0" class="animate-fade-in">
      <h3 class="font-bold px-2 mb-3 text-base sm:text-lg" [style.color]="'var(--text-primary)'">
        Desglose Mensual
      </h3>
      <div class="space-y-2 sm:space-y-3">
        <div
          *ngFor="let cat of categoryStats()"
          class="p-3 sm:p-4 rounded-2xl flex items-center gap-3 sm:gap-4 shadow-sm border transition"
          [style.background-color]="'var(--bg-card)'"
          [style.border-color]="'var(--border-color)'"
        >
          <div class="text-xl sm:text-2xl w-8 sm:w-10 text-center">{{ cat.icon }}</div>
          <div class="flex-1">
            <div class="flex justify-between mb-1">
              <span class="font-bold text-xs sm:text-sm" [style.color]="'var(--text-primary)'">{{
                cat.name
              }}</span>
              <span class="font-bold text-xs sm:text-sm" [style.color]="'var(--text-primary)'">
                >${{ cat.total }}</span
              >
            </div>
            <div class="w-full bg-gray-50 rounded-full h-2 overflow-hidden">
              <div
                class="h-full bg-pastel-accent transition-all duration-1000"
                [style.width.%]="cat.percent"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="currentTab() === 'movements'" class="p-6 animate-fade-in space-y-6">
    <div
      class="p-6 rounded-[2rem] shadow-lg border relative transition-all"
      [style.background-color]="'var(--bg-card)'"
      [style.border-color]="'var(--border-color)'"
      [class.ring-2]="isEditing()"
      [class.ring-pastel-primary]="isEditing()"
    >
      <div class="flex justify-between items-center mb-6">
        <h3 class="font-bold text-xl" [style.color]="'var(--text-primary)'">
          {{
            isEditing()
              ? 'Editar Gasto âœï¸'
              : 'Nuevo
          Gasto âœ¨'
          }}
        </h3>
        <button
          *ngIf="isEditing()"
          (click)="cancelEdit()"
          class="text-xs bg-gray-100 px-3 py-1 rounded-full text-gray-500"
        >
          Cancelar
        </button>
      </div>

      <div class="space-y-4">
        <input [(ngModel)]="expenseForm.name" placeholder="Concepto" class="input-pastel text-lg" />

        <div class="flex gap-3">
          <div class="flex items-center gap-2">
            <span class="text-2xl font-bold" [style.color]="'var(--text-secondary)'">$</span>
            <input
              [(ngModel)]="expenseForm.amount"
              type="number"
              min="0"
              max="1000000"
              step="5"
              placeholder="0"
              class="input-pastel font-bold text-l flex-1"
            />
          </div>
          <input
            [(ngModel)]="expenseForm.date"
            type="date"
            class="input-pastel text-gray-500 text-sm"
          />
        </div>

        <div class="grid grid-cols-4 gap-2">
          <button
            *ngFor="let cat of categories"
            (click)="expenseForm.category = cat"
            class="p-2 rounded-xl text-xl flex flex-col items-center justify-center transition border-2"
            [class.border-black]="expenseForm.category === cat"
            [class.bg-gray-50]="expenseForm.category !== cat"
            [class.border-transparent]="expenseForm.category !== cat"
          >
            {{ getIcon(cat) }}
          </button>
        </div>

        <button
          (click)="saveExpense()"
          class="w-full py-4 rounded-xl font-bold shadow-xl active:scale-95 transition mt-2 text-white"
          [class.bg-pastel-tertiary]="isEditing()"
          [class.bg-black]="!isEditing()"
        >
          {{ isEditing() ? 'Guardar Cambios' : 'Agregar Gasto' }}
        </button>
      </div>
    </div>

    <div class="flex justify-between items-end px-2">
      <h3 class="font-bold" [style.color]="'var(--text-primary)'">Ãšltimos movimientos</h3>
      <span class="text-xs bg-pastel-bg px-2 py-1 rounded text-gray-500"
        >{{ expenseService.expenses().length }} reg.</span
      >
    </div>

    <div
      *ngFor="let item of expenseService.expenses()"
      class="group p-4 rounded-2xl flex justify-between items-center shadow-sm hover:shadow-md transition cursor-pointer border-l-4"
      [style.background-color]="'var(--bg-card)'"
      [class.border-pastel-secondary]="item.user_id === expenseService.user().id"
      [class.border-pastel-primary]="item.user_id !== expenseService.user().id"
      (click)="item.user_id === expenseService.user().id ? edit(item) : null"
    >
      <div class="flex items-center gap-4">
        <div class="text-2xl">{{ getIcon(item.category) }}</div>
        <div>
          <p class="font-bold" [style.color]="'var(--text-primary)'">{{ item.name }}</p>
          <div class="flex gap-2 text-xs text-gray-400 font-semibold">
            <span>{{ item.date }}</span>
            <span
              *ngIf="item.user_id === expenseService.user().id"
              class="text-pastel-secondary bg-green-50 px-1 rounded"
              >TÃº</span
            >
          </div>
        </div>
      </div>

      <div class="flex flex-col items-end">
        <p class="font-bold text-lg" [style.color]="'var(--text-primary)'">${{ item.amount }}</p>
        <button
          *ngIf="item.user_id === expenseService.user().id"
          (click)="$event.stopPropagation(); delete(item.id!)"
          class="opacity-0 group-hover:opacity-100 transition text-xs text-red-400 hover:bg-red-50 px-2 py-1 rounded mt-1"
        >
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="currentTab() === 'budgets'" class="p-6 animate-fade-in space-y-6">
    <div
      class="p-6 rounded-[2rem] shadow-lg border relative transition-all"
      [style.background-color]="'var(--bg-card)'"
      [style.border-color]="'var(--border-color)'"
    >
      <div class="mb-6">
        <h3 class="font-bold text-xl mb-2" [style.color]="'var(--text-primary)'">
          Definir Presupuesto ğŸ’°
        </h3>
        <p class="text-sm" [style.color]="'var(--text-secondary)'">
          Establece lÃ­mites para controlar tus gastos
        </p>
      </div>

      <div class="space-y-4">
        <div class="grid grid-cols-4 gap-2">
          <button
            *ngFor="let cat of categories"
            (click)="budgetForm.category = cat"
            class="p-3 rounded-xl text-xl flex flex-col items-center justify-center transition border-2"
            [class.border-black]="budgetForm.category === cat"
            [class.border-transparent]="budgetForm.category !== cat"
            [style.background-color]="
              budgetForm.category === cat ? 'var(--bg-input)' : 'transparent'
            "
          >
            {{ getIcon(cat) }}
            <span class="text-xs mt-1" [style.color]="'var(--text-secondary)'">{{ cat }}</span>
          </button>
        </div>

        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold" [style.color]="'var(--text-secondary)'">$</span>
          <input
            [(ngModel)]="budgetForm.limit"
            type="number"
            placeholder="LÃ­mite mensual"
            class="input-pastel font-bold text-xl flex-1"
          />
        </div>

        <button
          (click)="saveBudget()"
          class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-xl active:scale-95 transition"
        >
          Guardar Presupuesto
        </button>
      </div>
    </div>

    <div *ngIf="categoryProgress().length > 0">
      <h3 class="font-bold px-2 mb-3" [style.color]="'var(--text-primary)'">Progreso del Mes</h3>

      <div class="space-y-3">
        <div
          *ngFor="let item of categoryProgress()"
          class="p-4 rounded-2xl shadow-sm border transition relative overflow-hidden"
          [style.background-color]="'var(--bg-card)'"
          [style.border-color]="'var(--border-color)'"
        >
          <div class="flex justify-between items-center mb-2 relative z-10">
            <div class="flex items-center gap-2">
              <span class="text-2xl">{{ getIcon(item.category) }}</span>
              <span class="font-bold" [style.color]="'var(--text-primary)'">{{
                item.category
              }}</span>
            </div>
            <button
              (click)="deleteBudget(item.category)"
              class="text-xs text-red-400 hover:bg-red-50 px-2 py-1 rounded transition"
            >
              Eliminar
            </button>
          </div>

          <div class="mb-2 relative z-10">
            <div class="flex justify-between text-sm font-semibold mb-1">
              <span [style.color]="'var(--text-secondary)'">Gastado: ${{ item.spent }}</span>
              <span [style.color]="'var(--text-secondary)'">LÃ­mite: ${{ item.limit }}</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
              <div
                class="h-full transition-all duration-1000"
                [style.width.%]="item.percent > 100 ? 100 : item.percent"
                [class.bg-green-500]="item.status === 'ok'"
                [class.bg-yellow-500]="item.status === 'warning'"
                [class.bg-red-500]="item.status === 'danger'"
              ></div>
            </div>
            <p
              class="text-xs text-center mt-1 font-bold"
              [class.text-green-600]="item.status === 'ok'"
              [class.text-yellow-600]="item.status === 'warning'"
              [class.text-red-600]="item.status === 'danger'"
            >
              {{ item.percent | number : '1.0-0' }}% utilizado
            </p>
          </div>

          <div
            *ngIf="item.percent > 100"
            class="absolute inset-0 bg-red-500/5 animate-pulse pointer-events-none"
          ></div>
        </div>
      </div>
    </div>

    <div *ngIf="categoryProgress().length === 0" class="text-center py-12 opacity-50">
      <span class="text-5xl block mb-3">ğŸ’°</span>
      <p [style.color]="'var(--text-secondary)'">AÃºn no has definido presupuestos</p>
      <p class="text-sm mt-1" [style.color]="'var(--text-secondary)'">
        Crea uno arriba para empezar a controlar tus gastos
      </p>
    </div>
  </div>

  <div
    *ngIf="currentTab() === 'balance'"
    class="p-6 animate-fade-in flex flex-col justify-center h-[80vh]"
  >
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold" [style.color]="'var(--text-primary)'">Balance de Cuentas</h2>
      <p class="text-sm" [style.color]="'var(--text-secondary)'">Â¿QuiÃ©n paga la prÃ³xima cena?</p>
    </div>

    <div
      class="p-10 rounded-[3rem] shadow-2xl text-center border-4 relative"
      [style.background-color]="'var(--bg-card)'"
      [class.border-pastel-secondary]="balance() > 0"
      [class.border-pastel-primary]="balance() < 0"
      [class.border-gray-100]="balance() === 0"
    >
      <div class="text-6xl mb-4 animate-bounce">
        {{ balance() > 0 ? 'ğŸ¤‘' : balance() < 0 ? 'ğŸ’¸' : 'ğŸ¤' }}
      </div>

      <h3 class="text-gray-500 font-bold uppercase tracking-widest text-xs mb-2">
        {{ balance() > 0 ? 'TE DEBEN' : balance() < 0 ? 'DEBES' : 'A MANO' }}
      </h3>

      <h1 class="text-6xl font-black mb-6" [style.color]="'var(--text-primary)'">
        ${{ (balance() < 0 ? balance() * -1 : balance()) | number : '1.0-0' }}
      </h1>

      <p class="text-sm text-gray-400 px-4 leading-relaxed">
        <span *ngIf="balance() > 0"
          >Yeini ha gastado menos. DeberÃ­a invitar la prÃ³xima salida para compensar.</span
        >
        <span *ngIf="balance() < 0"
          >Airam ha gastado menos que Yeini. Le toca poner para equilibrar la balanza.</span
        >
        <span *ngIf="balance() === 0">Â¡IncreÃ­ble! Han gastado exactamente lo mismo.</span>
      </p>
    </div>
  </div>

  <nav
    class="fixed bottom-8 left-8 right-8 backdrop-blur-xl border rounded-full p-2 flex justify-between shadow-2xl z-50 max-w-xs mx-auto transition-colors"
    [style.background-color]="'var(--bg-card)'"
    [style.border-color]="'var(--border-color)'"
  >
    <button
      (click)="currentTab.set('dashboard')"
      class="nav-btn"
      [class.active]="currentTab() === 'dashboard'"
    >
      ğŸ“Š
    </button>
    <button
      (click)="currentTab.set('movements')"
      class="nav-btn"
      [class.active]="currentTab() === 'movements'"
    >
      ğŸ’¸
    </button>
    <button
      (click)="currentTab.set('budgets')"
      class="nav-btn"
      [class.active]="currentTab() === 'budgets'"
    >
      ğŸ’°
    </button>
    <button
      (click)="currentTab.set('balance')"
      class="nav-btn"
      [class.active]="currentTab() === 'balance'"
    >
      âš–ï¸
    </button>
  </nav>
</div>
